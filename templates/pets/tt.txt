–º–æ–∂–µ—à—å –æ—Ç–º–µ—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∑–µ–ª—ë–Ω—ã–º 
{% extends '_base.html' %}
{% load static %}
{% block title %}{{ pet.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pets.css' %}">
{% endblock %}

{% block content %}
<div class="pet-card">
    <h1>{{ pet.name }}</h1>
    
    <div class="pet-info">
        <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> {{ pet.age }}</p>
        {% if pet.breed %}
            <p><strong>–ü–æ—Ä–æ–¥–∞:</strong> {{ pet.breed }}</p>
        {% endif %}

        {% if pet.gender %}
            <p><strong>–ü–æ–ª:</strong> {{ pet.get_gender_display }}</p>
        {% endif %}

        {% if pet.weight %}
            <p><strong>–í–µ—Å:</strong> {{ pet.weight }} –∫–≥</p>
        {% endif %}
    </div>

    {% if pet.photo %}
        <img src="{{ pet.photo.url }}" alt="{{ pet.name }}" class="pet-photo">
    {% else %}
        <img src="{% static 'img/pet_placeholder.jpg' %}" alt="–ü–∏—Ç–æ–º–µ—Ü" class="pet-photo">
    {% endif %}
</div>

<div class="tabs">
    <a href="?tab=info" class="{% if tab == 'info' %}active{% endif %}">–ò–Ω—Ñ–æ</a>
    <a href="?tab=training" class="{% if tab == 'training' %}active{% endif %}">–î—Ä–µ—Å—Å–∏—Ä–æ–≤–∫–∞</a>
    <a href="?tab=calendar" class="{% if tab == 'calendar' %}active{% endif %}">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
</div>

<div class="tab-content">
    {% if tab == 'info' %}
        <p><strong>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ pet.birthday|date:"d.m.Y" }}</p>
        {% if birthday_today %}
            <p><strong>üéâ –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É {{ pet.name }}!</strong></p>
        {% elif birthday_soon %}
            <p><strong>‚è≥ –ß–µ—Ä–µ–∑ {{ birthday_soon }} –¥–Ω–µ–π —É {{ pet.name }} –î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è!</strong></p>
        {% endif %}

        <p><strong>–í–ª–∞–¥–µ–ª—å—Ü—ã:</strong></p>
        <ul>
            {% for owner in pet.owners.all %}
                <li>{{ owner.email }}</li>
            {% endfor %}
        </ul>
        <p><a href="{% url 'pets:edit' pet.id %}" class="btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a></p>

    {% elif tab == 'training' %}
        <div class="tabs mini-tabs">
            <a href="?tab=training&filter=in_progress" class="{% if filter == 'in_progress' %}active{% endif %}">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</a>
            <a href="?tab=training&filter=completed" class="{% if filter == 'completed' %}active{% endif %}">–ó–∞–≤–µ—Ä—à–µ–Ω—ã</a>
        </div>
        
        {% if lessons %}
            {% for lesson in lessons %}
                <div class="card">
                    <div class="card-title">
                        <a href="{% url 'training:lesson_detail' lesson.id %}?pet={{ pet.id }}">{{ lesson.title }}</a>
                    </div>
                    <p>{{ lesson.description|truncatechars:150 }}</p>

                    {% with lesson_progress=lesson.get_progress_for_pet_id|default_if_none:"" %}
                    <p>
                        {% if lesson.id in completed_lessons %}
                            ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ |
                            <a href="{% url 'training:set_status' pet.id lesson.id 'in_progress' %}">–í–µ—Ä–Ω—É—Ç—å –≤ –ø—Ä–æ—Ü–µ—Å—Å</a>
                        {% elif lesson.id in in_progress_lessons %}
                            ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ |
                            <a href="{% url 'training:set_status' pet.id lesson.id 'completed' %}">–ó–∞–≤–µ—Ä—à–∏—Ç—å</a>
                        {% else %}
                            ‚ùå –ù–µ –Ω–∞—á–∞—Ç |
                            <a href="{% url 'training:set_status' pet.id lesson.id 'in_progress' %}">–ù–∞—á–∞—Ç—å</a>
                        {% endif %}
                    </p>
                    {% endwith %}
                </div>
            {% endfor %}
        {% else %}
            <p>–£—Ä–æ–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endif %}

    {% elif tab == 'calendar' %}
        <div id="calendar"></div>

        <div id="eventModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>–°–æ–±—ã—Ç–∏—è –Ω–∞ <span id="eventDate"></span></h2>
                <div id="eventList"></div>
            </div>
        </div>

        <p style="margin-top: 20px;">
            <a href="{% url 'calendarapp:add' pet.id %}" class="btn">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</a>
        </p>

        <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const calendarEl = document.getElementById('calendar');
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ru',
                    height: 'auto',
                    events: [
                        {% for event in events %}
                        {
                            title: '{{ event.title }}',
                            start: '{{ event.date|date:"Y-m-d" }}',
                            end: '{{ event.date|date:"Y-m-d" }}',
                            extendedProps: {
                                id: '{{ event.id }}',
                                time: '{{ event.time|default:"" }}',
                                note: `{{ event.note|default_if_none:"" }}`,
                                is_done: {{ event.is_done|yesno:"true,false" }},
                                remind: `{% if event.reminder %}{{ event.reminder.remind_at|time:"H:i" }}{% endif %}`,
                                is_yearly: {{ event.is_yearly|yesno:"true,false" }},
                                edit_url: '{% url 'calendarapp:edit' event.id %}',
                                done_url: '{% url 'calendarapp:done' event.id %}',
                                delete_url: '{% url 'calendarapp:delete' event.id %}'
                            }
                        },
                        {% endfor %}
                    ],
                    dateClick: function(info) {
                        const clickedDate = info.dateStr;
                        document.getElementById('eventDate').innerText = clickedDate;

                        const matched = calendar.getEvents().filter(e => e.startStr === clickedDate);
                        let html = '';

                        if (matched.length > 0) {
                            matched.forEach(event => {
                                const yearlyNote = event.extendedProps.is_yearly ? ' (–ï–∂–µ–≥–æ–¥–Ω–æ–µ)' : '';
                                html += `<div class="event-card">
                                    <b>${event.title}${yearlyNote}</b><br>
                                    ${event.extendedProps.time ? `–í—Ä–µ–º—è: ${event.extendedProps.time}<br>` : ''}
                                    ${event.extendedProps.note ? `–ó–∞–º–µ—Ç–∫–∞: ${event.extendedProps.note}<br>` : ''}
                                    ${event.extendedProps.remind ? `<i>–ù–∞–ø–æ–º–Ω–∏—Ç—å: ${event.extendedProps.remind}</i><br>` : ''}
                                    ${event.extendedProps.is_done ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'}<br>
                                    <a href="${event.extendedProps.edit_url}" class="btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                                    ${!event.extendedProps.is_done ? `<a href="${event.extendedProps.done_url}" class="btn">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</a>` : ''}
                                    <a href="${event.extendedProps.delete_url}" class="btn" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ?')">üóë –£–¥–∞–ª–∏—Ç—å</a>
                                </div><br>`;
                            });
                        } else {
                            html = '<p>–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</p>';
                        }

                        document.getElementById('eventList').innerHTML = html;
                        document.getElementById('eventModal').style.display = 'block';
                    }
                });

                calendar.render();

                // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                console.log('Events:', calendar.getEvents());
            });

            function closeModal() {
                document.getElementById('eventModal').style.display = 'none';
            }
        </script>

        <style>
            #calendar {
                max-width: 900px;
                margin: 0 auto;
            }

            .modal {
                position: fixed;
                z-index: 9999;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0,0,0,0.4);
            }

            .modal-content {
                background-color: #fff;
                margin: 10% auto;
                padding: 20px;
                border-radius: 8px;
                width: 80%;
                max-width: 500px;
            }

            .close {
                float: right;
                font-size: 28px;
                cursor: pointer;
            }

            .card {
                background: #f9f9f9;
                padding: 10px;
                border-radius: 6px;
            }
        </style>
    {% endif %}


</div>
{% endblock %}