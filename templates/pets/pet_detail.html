{% extends '_base.html' %}
{% load static %}
{% block title %}{{ pet.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pets.css' %}">
{% endblock %}

{% block content %}
<div class="pet-card">
    <h1>{{ pet.name }}</h1>
    
    <div class="pet-info">
        <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> {{ pet.age }}</p>
        {% if pet.breed %}
            <p><strong>–ü–æ—Ä–æ–¥–∞:</strong> {{ pet.breed }}</p>
        {% endif %}

        {% if pet.gender %}
            <p><strong>–ü–æ–ª:</strong> {{ pet.get_gender_display }}</p>
        {% endif %}

        {% if pet.weight %}
            <p><strong>–í–µ—Å:</strong> {{ pet.weight }} –∫–≥</p>
        {% endif %}
        
        {% if pet.features %}
            <details>
                <summary><strong>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</strong> (–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)</summary>
                <div class="pet-features">
                    <div class="features-content">{{ pet.features }}</div>
                </div>
            </details>
        {% endif %}
    </div>

    {% if pet.photo %}
        <img src="{{ pet.photo.url }}" alt="{{ pet.name }}" class="pet-photo">
    {% else %}
        <img src="{% static 'img/pet_placeholder.jpg' %}" alt="–ü–∏—Ç–æ–º–µ—Ü" class="pet-photo">
    {% endif %}
</div>

<div class="tabs">
    <a href="?tab=info" class="{% if tab == 'info' %}active{% endif %}">–ò–Ω—Ñ–æ</a>
    <a href="?tab=training" class="{% if tab == 'training' %}active{% endif %}">–î—Ä–µ—Å—Å–∏—Ä–æ–≤–∫–∞</a>
    <a href="?tab=calendar" class="{% if tab == 'calendar' %}active{% endif %}">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
</div>

<div class="tab-content">
    {% if tab == 'info' %}
        <p><strong>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ pet.birthday|date:"d.m.Y" }}</p>
        {% if birthday_today %}
            <p><strong>üéâ –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É {{ pet.name }}!</strong></p>
        {% elif birthday_soon %}
            <p><strong>‚è≥ –ß–µ—Ä–µ–∑ {{ birthday_soon }} –¥–Ω–µ–π —É {{ pet.name }} –î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è!</strong></p>
        {% endif %}

        <p><strong>–í–ª–∞–¥–µ–ª—å—Ü—ã:</strong></p>
        <ul>
            {% for owner in pet.owners.all %}
                <li>{{ owner.email }}</li>
            {% endfor %}
        </ul>
        <p><a href="{% url 'pets:edit' pet.id %}" class="btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a></p>

    {% elif tab == 'training' %}
        <div class="tabs mini-tabs">
            <a href="?tab=training&filter=in_progress" class="{% if filter == 'in_progress' %}active{% endif %}">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</a>
            <a href="?tab=training&filter=completed" class="{% if filter == 'completed' %}active{% endif %}">–ó–∞–≤–µ—Ä—à–µ–Ω—ã</a>
        </div>
        
        {% if lessons %}
            {% for lesson in lessons %}
                <div class="card">
                    <div class="card-title">
                        <a href="{% url 'training:lesson_detail' lesson.id %}?pet={{ pet.id }}">{{ lesson.title }}</a>
                    </div>
                    <p>{{ lesson.description|truncatechars:150 }}</p>

                    {% with lesson_progress=lesson.get_progress_for_pet_id|default_if_none:"" %}
                    <p>
                        {% if lesson.id in completed_lessons %}
                            ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ |
                            <a href="{% url 'training:set_status' pet.id lesson.id 'in_progress' %}">–í–µ—Ä–Ω—É—Ç—å –≤ –ø—Ä–æ—Ü–µ—Å—Å</a>
                        {% elif lesson.id in in_progress_lessons %}
                            ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ |
                            <a href="{% url 'training:set_status' pet.id lesson.id 'completed' %}">–ó–∞–≤–µ—Ä—à–∏—Ç—å</a>
                        {% else %}
                            ‚ùå –ù–µ –Ω–∞—á–∞—Ç |
                            <a href="{% url 'training:set_status' pet.id lesson.id 'in_progress' %}">–ù–∞—á–∞—Ç—å</a>
                        {% endif %}
                    </p>
                    {% endwith %}
                </div>
            {% endfor %}
        {% else %}
            <p>–£—Ä–æ–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endif %}

        {% elif tab == 'calendar' %}

        <div id="calendar"></div>
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <div id="eventModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>–°–æ–±—ã—Ç–∏—è –Ω–∞ <span id="eventDate"></span></h2>
                <div id="eventList"></div>
            </div>
        </div>

        <p style="margin-top: 20px;">
            <a href="{% url 'calendarapp:add' pet.id %}" class="btn">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</a>
        </p>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ru',
                height: 'auto',
                events: [
                    {% for event in events %}
                    {
                        title: '{{ event.title }}{% if event.is_done %} ‚úÖ{% endif %}',
                        start: '{{ event.date|date:"Y-m-d" }}',
                        end: '{{ event.date|date:"Y-m-d" }}',
                        className: '{{ event.is_done|yesno:"done,not-done" }}',
                        backgroundColor: '{{ event.is_done|yesno:"rgb(128, 238, 114),#ffffff" }}',
                        textColor: '{{ event.is_done|yesno:"#000000,#000000" }}',
                        borderColor: '{{ event.is_done|yesno:"rgb(100, 200, 100),#ddd" }}',
                        extendedProps: {
                            id: '{{ event.id }}',
                            time: '{{ event.time|default:"" }}',
                            note: `{{ event.note|default_if_none:"" }}`,
                            is_done: {{ event.is_done|yesno:"true,false" }},
                            remind: `{% if event.reminder %}{{ event.reminder.remind_at|time:"H:i" }}{% endif %}`,
                            is_yearly: {{ event.is_yearly|yesno:"true,false" }},
                            edit_url: '{% url 'calendarapp:edit' event.id %}',
                            done_url: '{% url 'calendarapp:done' event.id %}',
                            delete_url: '{% url 'calendarapp:delete' event.id %}'
                        }
                    },
                    {% endfor %}
                ],
                dateClick: function(info) {
                    const clickedDate = info.dateStr;
                    document.getElementById('eventDate').innerText = clickedDate;

                    const matched = calendar.getEvents().filter(e => e.startStr === clickedDate);
                    let html = '';

                    if (matched.length > 0) {
                        matched.forEach(event => {
                            const yearlyNote = event.extendedProps.is_yearly ? ' (–ï–∂–µ–≥–æ–¥–Ω–æ–µ)' : '';
                            const statusClass = event.extendedProps.is_done ? 'done' : 'not-done';
                            html += `
                                <div class="event-card ${statusClass}">
                                    <b>${event.title} - ${event.startStr}${yearlyNote}</b><br>
                                    ${event.extendedProps.time ? `–í—Ä–µ–º—è: ${event.extendedProps.time}<br>` : ''}
                                    ${event.extendedProps.note ? `–ó–∞–º–µ—Ç–∫–∞: ${event.extendedProps.note}<br>` : ''}
                                    ${event.extendedProps.remind ? `<i>–ù–∞–ø–æ–º–Ω–∏—Ç—å: ${event.extendedProps.remind}</i><br>` : ''}
                                    ${event.extendedProps.is_done ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'}<br>
                                    <div class="event-actions">
                                        <a href="${event.extendedProps.edit_url}" class="btn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                                        ${!event.extendedProps.is_done ? 
                                            `<a href="${event.extendedProps.done_url}" class="btn" 
                                                onclick="return confirm('–û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ?')">
                                                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                                            </a>` 
                                            : ''
                                        }
                                        <form action="${event.extendedProps.delete_url}" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ?')">
                                            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                            <button type="submit" class="btn">üóë –£–¥–∞–ª–∏—Ç—å</button>
                                            <label for="id_delete_all">
                                                <input type="checkbox" id="id_delete_all" name="delete_all">
                                                –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å —ç—Ç–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º
                                            </label>
                                        </form>
                                    </div>
                                </div><br>`;
                        });
                    } else {
                        html = '<p>–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</p>';
                    }

                    document.getElementById('eventList').innerHTML = html;
                    document.getElementById('eventModal').style.display = 'block';
                }
            });

            calendar.render();

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —è–∫–æ—Ä—è –≤ URL
            if (window.location.hash) {
                const dateStr = window.location.hash.slice(1);
                try {
                    const date = new Date(dateStr);
                    if (!isNaN(date)) {
                        calendar.gotoDate(date);
                        
                        setTimeout(() => {
                            const calendarTop = calendarEl.getBoundingClientRect().top;
                            const offset = window.pageYOffset + calendarTop - 100;
                            window.scrollTo({
                                top: offset,
                                behavior: 'smooth'
                            });
                        }, 100);
                    }
                } catch (e) {
                    console.error('Invalid date in hash:', e);
                }
            }
        });

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }
    </script>
    
        <style>
            #calendar {
                max-width: 900px;
                margin: 0 auto;
            }
    
            .modal {
                position: fixed;
                z-index: 9999;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0,0,0,0.4);
            }
    
            .modal-content {
                background-color: #fff;
                margin: 10% auto;
                padding: 20px;
                border-radius: 8px;
                width: 80%;
                max-width: 500px;
            }
    
            .close {
                float: right;
                font-size: 28px;
                cursor: pointer;
            }
    
            .event-card {
                border: 1px solid #ddd;
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 4px;
            }
    
            .event-card.done {
                background-color:rgb(130, 255, 157);
                color: #666;
            }
    
            .event-actions {
                margin-top: 10px;
            }
    
            .event-actions .btn {
                margin-right: 5px;
                margin-bottom: 5px;
            }
    
            .not-done {
                background-color: #fff;
            }
    
            .done {
                background-color:rgb(128, 238, 114);
                color: #666;
            }
            @media screen and (max-width: 768px) {
                /* –û–±—â–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
                .fc {
                    font-size: 0.85em;
                }
                
                /* –£–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ */
                .fc-col-header-cell {
                    font-size: 0.9em;
                }
                
                /* –£–º–µ–Ω—å—à–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã —è—á–µ–µ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
                .fc-daygrid-day {
                    min-height: 2.5em;
                }
                
                /* –£–º–µ–Ω—å—à–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–æ–≤ –≤–Ω—É—Ç—Ä–∏ —è—á–µ–µ–∫ */
                .fc-daygrid-day-frame {
                    padding: 2px;
                }
                
                /* –£–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –Ω–æ–º–µ—Ä–æ–≤ –¥–Ω–µ–π */
                .fc-daygrid-day-number {
                    font-size: 0.9em;
                    padding: 2px 4px !important;
                }
                
                /* –£–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –Ω–∞–∑–≤–∞–Ω–∏–π —Å–æ–±—ã—Ç–∏–π */
                .fc-event-title {
                    font-size: 0.85em;
                }
                
                /* –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
                .modal-content {
                    width: 95%;
                    margin: 5% auto;
                    padding: 15px;
                }
                
                /* –ö–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ–±—ã—Ç–∏—è */
                .event-actions {
                    display: flex;
                    flex-direction: column;
                }
                
                .event-actions .btn,
                .event-actions form {
                    width: 100%;
                    margin-bottom: 5px;
                }
                
                /* –£–ª—É—á—à–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π */
                .event-actions form label {
                    display: flex;
                    align-items: center;
                    margin-top: 5px;
                }
                
                .event-actions form input[type="checkbox"] {
                    margin-right: 5px;
                }
            }
            
            /* –î–ª—è —Å–æ–≤—Å–µ–º –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
            @media screen and (max-width: 480px) {
                /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
                .fc-toolbar-chunk:not(:first-child) {
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: center;
                }
                
                /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É —à–∞–ø–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
                .fc-toolbar {
                    flex-wrap: wrap;
                    gap: 5px;
                }
                
                /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø–æ —Ü–µ–Ω—Ç—Ä—É */
                .fc-toolbar-title {
                    font-size: 1.1em !important;
                    text-align: center;
                    width: 100%;
                }
                
                /* –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –º–µ—Å—è—Ü–µ–≤ */
                .fc-button {
                    padding: 0.2em 0.5em !important;
                    font-size: 0.9em !important;
                }
            }
        </style>
    {% endif %}


</div>
{% endblock %}